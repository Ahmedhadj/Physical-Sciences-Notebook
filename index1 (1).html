<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الدفتر الشامل للأستاذ - الإصدار الصحيح</title>

    <!-- Google Fonts & Font Awesome -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css">

    <!-- External JS Libraries for Attendance System -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        :root {
            --primary-color: #2980b9; --secondary-color: #3498db; --header-bg: #ecf0f1;
            --border-color: #bdc3c7; --text-color: #34495e; --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e; --sidebar-active: #1abc9c; --danger-color: #c0392b;
            --success-bg: #d4edda; --success-color: #155724; --error-bg: #f8d7da;
            --error-color: #721c24; --info-bg: #d1ecf1; --info-color: #0c5460;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; margin: 0; background-color: #f0f2f5; color: var(--text-color); }
        .container { display: flex; }
        .sidebar { width: 280px; background-color: var(--sidebar-bg); color: white; padding: 20px; height: 100vh; position: fixed; overflow-y: auto; }
        .sidebar h2 { text-align: center; color: #ecf0f1; margin-bottom: 30px; }
        .sidebar ul { list-style-type: none; padding: 0; }
        .sidebar ul li { padding: 15px 20px; cursor: pointer; transition: background-color 0.3s; border-right: 4px solid transparent; border-radius: 5px 0 0 5px; margin-bottom: 5px;}
        .sidebar ul li:hover, .sidebar ul li.active { background-color: var(--sidebar-hover); border-right-color: var(--sidebar-active); }
        .main-content { margin-right: 300px; padding: 25px; width: calc(100% - 300px); }
        .content-section { display: none; background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .content-section.active { display: block; }
        .section-title { background: linear-gradient(to left, var(--primary-color), var(--secondary-color)); color: white; padding: 10px 20px; border-radius: 8px; text-align: center; font-size: 1.8em; margin: 0 0 30px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 1em; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: center; vertical-align: middle; }
        th { background-color: var(--header-bg); font-weight: 700; }
        .notebook-input, .notebook-textarea { width: 100%; padding: 8px; border: none; background: transparent; font-family: inherit; font-size: 1em; box-sizing: border-box; }
        .notebook-textarea { resize: vertical; min-height: 80px; }
        .teacher-card-info p { font-size: 1.2em; padding: 10px 0; border-bottom: 1px dotted var(--border-color); display: flex; align-items: center; }
        .teacher-card-info strong { display: inline-block; width: 200px; flex-shrink: 0; }
        .table-actions { text-align: left; margin-top: 15px; }
        .btn-add-row, .btn-add-seat { background-color: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-family: inherit; font-size: 0.9em; transition: background-color 0.3s; }
        .btn-add-row:hover, .btn-add-seat:hover { background-color: var(--secondary-color); }
        .btn-delete-row { background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 1.2em; }
        td.actions-cell { width: 60px; }
        .seating-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; }
        .seat { border: 1px solid #ccc; border-radius: 5px; padding: 5px; position: relative; }
        .seat .notebook-input { text-align: center; }
        .btn-delete-seat { position: absolute; top: -5px; left: -5px; background-color: var(--danger-color); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; line-height: 20px; text-align: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: all 0.3s ease; margin: 5px; display: inline-flex; align-items: center; gap: 8px; vertical-align: middle; } .btn-add { background-color: #28a745; color: white; } .btn-report { background-color: #ffc107; color: #333; } .btn-secondary { background-color: #6c757d; color: white; } .btn-export { background-color: #17a2b8; color: white; } .btn-action { background-color: var(--secondary-color); color: white; font-size: 0.85em; padding: 4px 10px; } .btn-scan { background-color: #6f42c1; color: white; } .btn-stop-scan { background-color: #dc3545; color: white; } .btn-small { padding: 6px 12px; font-size: 0.9em; } .btn-delete { background-color: #dc3545; color: white; font-size: 0.85em; padding: 4px 10px; }
        #attendance-system .form-section { background-color: #fdfdfd; padding: 25px; border-radius: 5px; margin-bottom: 25px; border: 1px solid #ddd; }
        #attendance-system h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-top: 30px; font-size: 1.5em; display: flex; align-items: center; gap: 10px; color: var(--primary-color); }
        #attendance-system .table-container { max-height: 450px; overflow: auto; border: 1px solid #ddd; background-color: #fff; margin-bottom: 20px; border-radius: 5px; }
        #attendance-system table thead th { background-color: var(--primary-color); color: white; position: sticky; top: 0; z-index: 10; }
        #attendance-system table tbody tr:nth-child(even) { background-color: #f8f9fa; }
        #qr-scanner-section { margin-top: 20px; padding: 20px; border: 1px solid #ccc; border-radius: 5px; background-color: #f8f9fa; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 350px; border-radius: 8px; text-align: center; position: relative; }
        .close-btn { color: #aaa; position: absolute; left: 15px; top: 10px; font-size: 28px; font-weight: bold; cursor: pointer; }
        #qrcode-container { margin: 20px auto; width: 256px; height: 256px; }
        .view { display: none; } .view.active-view { display: block; }
        .status-message { margin-top: 15px; padding: 12px 15px; border-radius: 5px; text-align: center; border: 1px solid transparent; }
        .status-message.success { background-color: var(--success-bg); color: var(--success-color); border-color: #c3e6cb; }
        .status-message.error { background-color: var(--error-bg); color: var(--error-color); border-color: #f5c6cb; }
        .status-message.info { background-color: var(--info-bg); color: var(--info-color); border-color: #bee5eb; }
        .status-message:empty { display: none; }
        #print-qr-container { display: none; }
        @media print { body > *:not(#print-qr-container) { display: none !important; } #print-qr-container { display: block !important; } .print-page { page-break-after: always; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8mm; padding: 10mm; } .qr-card { border: 1px dashed #999; text-align: center; padding: 10px; } }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <h2>الدفتر الشامل</h2>
        <ul>
            <li onclick="showSection('welcome-page')" class="active">🏠 الصفحة الرئيسية</li>
            <li onclick="showSection('teacher-card')">💳 البطاقة الفنية</li>
            <li onclick="showSection('attendance-system')">✅ نظام الحضور والغياب</li>
            <li onclick="showSection('school-diary')">📅 اليومية المدرسية</li>
            <li onclick="showSection('assigned-groups')">👨‍🏫 الأفواج والتوقيت</li>
            <li onclick="showSection('daily-notebook')">📓 الدفتر اليومي</li>
            <li onclick="showSection('grading-book')">📊 دفتر التنقيط</li>
            <li onclick="showSection('seating-chart')">🪑 مخطط الجلوس</li>
            <li onclick="showSection('annual-distribution')">🗓️ التوزيع السنوي</li>
            <li onclick="showSection('training-days')">🎓 أيام تكوينية</li>
            <li onclick="showSection('inspection-visits')">🔍 زيارات تفتيشية</li>
            <li onclick="showSection('teachers-list')">👥 قائمة الأساتذة</li>
            <li onclick="showSection('teacher-notepad')">📝 مفكرة الأستاذ</li>
        </ul>
    </div>

    <div class="main-content">
        <!-- Welcome Page -->
        <div id="welcome-page" class="content-section active">
            <h3 class="section-title">مرحباً بك في الإصدار النهائي من دفتر الأستاذ</h3>
            <p style="text-align: center; font-size: 1.2em;">يجمع هذا الدفتر بين أدوات التنظيم ونظام متكامل لإدارة الحضور.</p>
        </div>
        
        <!-- البطاقة الفنية -->
        <div id="teacher-card" class="content-section">
            <h3 class="section-title">البطاقة الفنية للأستاذ(ة)</h3>
            <div class="teacher-card-info">
                <p><strong>الإسم واللقب:</strong> <input type="text" class="notebook-input"></p>
                <p><strong>تاريخ ومكان الازدياد:</strong> <input type="text" class="notebook-input"></p>
                <p><strong>الحالة العائلية:</strong> <input type="text" class="notebook-input"></p>
                <p><strong>العنوان:</strong> <input type="text" class="notebook-input"></p>
                <p><strong>البريد الإلكتروني:</strong> <input type="email" class="notebook-input"></p>
                <p><strong>رقم الهاتف:</strong> <input type="text" class="notebook-input"></p>
                <hr style="margin: 20px 0; border: 0; border-top: 1px dotted var(--border-color);">
                <p><strong>التخصص:</strong> <input type="text" class="notebook-input" value="العلوم الفيزيائية"></p>
                <p><strong>تاريخ أول تعيين:</strong> <input type="text" class="notebook-input"></p>
                <p><strong>اسم المؤسسة:</strong> <input type="text" class="notebook-input"></p>
            </div>
        </div>

        <!-- نظام الحضور والغياب -->
        <div id="attendance-system" class="content-section">
            <!-- المحتوى الكامل لنظام الحضور هنا -->
            <div id="management-view" class="view active-view">
                <h3 class="section-title">نظام إدارة الحضور والغياب</h3>
                <section class="form-section">
                    <h2><i class="fas fa-user-plus"></i> إضافة طالب جديد</h2>
                    <form id="add-student-form"><div class="form-grid"><div class="form-group"><label for="first-name">الاسم:</label><input type="text" id="first-name" required></div><div class="form-group"><label for="last-name">اللقب:</label><input type="text" id="last-name" required></div><div class="form-group"><label for="student-id">رقم التعريف:</label><input type="text" id="student-id" required pattern="\d+"></div><div class="form-group"><label for="class-name">القسم:</label><input type="text" id="class-name" required></div></div><button type="submit" class="btn btn-add"><i class="fas fa-plus-circle"></i> إضافة الطالب</button></form>
                    <div id="add-student-status" class="status-message"></div>
                </section>
                <section class="form-section">
                    <h2><i class="fas fa-file-import"></i> استيراد قائمة الطلاب</h2>
                    <input type="file" id="import-file" accept=".csv, .xlsx, .xls" style="margin-bottom: 10px;"><button id="import-students-btn" class="btn btn-secondary btn-small"><i class="fas fa-upload"></i> استيراد</button>
                    <div id="import-status" class="status-message"></div>
                </section>
                <section>
                    <h2><i class="fas fa-users"></i> قائمة الطلاب (<span id="total-students-count">0</span>)</h2>
                    <div class="table-container"><table id="student-table"><thead><tr><th>الرقم</th><th>الاسم</th><th>اللقب</th><th>القسم</th><th>إجراءات</th></tr></thead><tbody id="student-list-body"></tbody></table></div>
                    <div style="text-align: center; margin-top: 15px;"><button id="export-students-csv-btn" class="btn btn-export btn-small" disabled><i class="fas fa-file-csv"></i> تصدير</button> <button id="print-qr-cards-btn" class="btn btn-action btn-small" disabled><i class="fas fa-id-card"></i> طباعة بطاقات</button></div>
                </section>
                <section id="qr-scanner-section">
                    <h2><i class="fas fa-qrcode"></i> تسجيل الحضور بالمسح</h2>
                    <div style="text-align: center; margin-bottom: 15px;"><button id="start-scan-btn" class="btn btn-scan"><i class="fas fa-camera"></i> بدء المسح</button><button id="stop-scan-btn" class="btn btn-stop-scan" style="display: none;"><i class="fas fa-stop-circle"></i> إيقاف</button></div>
                    <div id="qr-reader" style="display: none; width: 100%; max-width: 500px; margin: auto;"></div>
                    <div id="qr-scan-status" class="status-message info"></div>
                </section>
                <section style="text-align: center; margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;"><button id="go-to-report-btn" class="btn btn-report"><i class="fas fa-chart-line"></i> عرض التقرير اليومي</button></section>
            </div>
            <div id="report-view" class="view">
                 <h3 class="section-title">تقرير الحضور اليومي</h3>
                 <button id="back-to-management-btn" class="btn btn-small btn-secondary" style="position: absolute; top: 35px; left: 35px;"><i class="fas fa-arrow-right"></i> عودة</button>
                 <div class="form-section"><div style="display:flex; align-items:center; gap: 15px; flex-wrap:wrap; margin-bottom: 20px;"><label for="report-date" style="font-weight:bold;">تقرير ليوم:</label><input type="date" id="report-date"><button id="refresh-report-btn" class="btn btn-small btn-add"><i class="fas fa-sync-alt"></i> تحديث</button></div><div style="display:flex; justify-content:space-around; background-color:#e9ecef; padding: 12px; border-radius:4px; font-weight:bold;"><span>نسبة الحضور: <strong id="attendance-percentage">0%</strong></span> <span>الحاضرون: <strong id="present-count">0</strong></span> <span>الغائبون: <strong id="absent-count">0</strong></span></div></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 25px;"><section><h3><i class="fas fa-user-check"></i> الحاضرون</h3><div class="table-container"><table id="present-table"><thead><tr><th>الاسم</th><th>القسم</th><th>الوقت</th></tr></thead><tbody id="present-list-body"></tbody></table></div></section><section><h3><i class="fas fa-user-times"></i> الغائبون</h3><div class="table-container"><table id="absent-table"><thead><tr><th>الاسم</th><th>القسم</th></tr></thead><tbody id="absent-list-body"></tbody></table></div></section></div>
                 <div style="text-align: center; margin-top: 25px;"><button id="export-report-csv-btn" class="btn btn-export" disabled><i class="fas fa-file-csv"></i> تصدير التقرير</button></div>
            </div>
        </div>
        
        <!-- الأقسام الديناميكية الأخرى -->
        <div id="school-diary" class="content-section">
            <h3 class="section-title">اليومية المدرسية</h3>
            <table><thead><tr><th>المناسبة</th><th>التاريخ</th><th>ملاحظات</th><th class="actions-cell"></th></tr></thead><tbody id="school-diary-tbody"><tr><td><input type="text" class="notebook-input"></td><td><input type="date" class="notebook-input"></td><td><input type="text" class="notebook-input"></td><td><button class="btn-delete-row" onclick="deleteRow(this)">🗑️</button></td></tr></tbody></table>
            <div class="table-actions"><button class="btn-add-row" onclick="addRow('school-diary-tbody')">➕ إضافة حدث</button></div>
        </div>
        <div id="assigned-groups" class="content-section">
            <h3 class="section-title">الأفواج المسندة</h3>
            <table><thead><tr><th>المستوى</th><th>الفوج</th><th>عدد التلاميذ</th><th class="actions-cell"></th></tr></thead><tbody id="groups-tbody"><tr><td><input type="text" class="notebook-input"></td><td><input type="text" class="notebook-input"></td><td><input type="number" class="notebook-input"></td><td><button class="btn-delete-row" onclick="deleteRow(this)">🗑️</button></td></tr></tbody></table>
            <div class="table-actions"><button class="btn-add-row" onclick="addRow('groups-tbody')">➕ إضافة فوج</button></div>
        </div>
        <div id="daily-notebook" class="content-section">
            <h3 class="section-title">الدفتر اليومي</h3>
            <table><thead><tr><th>التاريخ</th><th>القسم</th><th>عنوان الدرس</th><th>ملاحظات</th><th class="actions-cell"></th></tr></thead><tbody id="daily-log-tbody"><tr><td><input type="date" class="notebook-input"></td><td><input type="text" class="notebook-input"></td><td><textarea class="notebook-textarea"></textarea></td><td><textarea class="notebook-textarea"></textarea></td><td><button class="btn-delete-row" onclick="deleteRow(this)">🗑️</button></td></tr></tbody></table>
            <div class="table-actions"><button class="btn-add-row" onclick="addRow('daily-log-tbody')">➕ إضافة حصة</button></div>
        </div>
        <div id="grading-book" class="content-section">
            <h3 class="section-title">دفتر التنقيط</h3>
            <table><thead><tr><th>#</th><th>الاسم الكامل</th><th>الفرض 1</th><th>الفرض 2</th><th>الاختبار</th><th>المعدل</th><th class="actions-cell"></th></tr></thead><tbody id="grading-tbody"><tr><td>01</td><td><input type="text" class="notebook-input"></td><td><input type="number" class="notebook-input"></td><td><input type="number" class="notebook-input"></td><td><input type="number" class="notebook-input"></td><td><input type="text" class="notebook-input" readonly></td><td><button class="btn-delete-row" onclick="deleteRow(this, 'grading-tbody')">🗑️</button></td></tr></tbody></table>
            <div class="table-actions"><button class="btn-add-row" onclick="addRow('grading-tbody')">➕ إضافة طالب</button></div>
        </div>
        <div id="seating-chart" class="content-section">
            <h3 class="section-title">مخطط الجلوس</h3>
            <div class="seating-grid" id="seating-grid-container"><div class="seat"><input type="text" class="notebook-input"><button class="btn-delete-seat" onclick="deleteSeat(this)">×</button></div></div>
            <div class="table-actions"><button class="btn-add-seat" onclick="addSeat('seating-grid-container')">➕ إضافة مقعد</button></div>
        </div>
        <div id="annual-distribution" class="content-section">
            <h3 class="section-title">التوزيع السنوي</h3>
            <table><thead><tr><th>الشهر</th><th>الأسبوع</th><th>الوحدة</th><th class="actions-cell"></th></tr></thead><tbody id="annual-dist-tbody"><tr><td><input type="text" class="notebook-input"></td><td><input type="text" class="notebook-input"></td><td><textarea class="notebook-textarea"></textarea></td><td><button class="btn-delete-row" onclick="deleteRow(this)">🗑️</button></td></tr></tbody></table>
            <div class="table-actions"><button class="btn-add-row" onclick="addRow('annual-dist-tbody')">➕ إضافة</button></div>
        </div>
        <div id="training-days" class="content-section">
            <h3 class="section-title">أيام تكوينية</h3>
            <table><thead><tr><th>التاريخ</th><th>الموضوع</th><th class="actions-cell"></th></tr></thead><tbody id="training-tbody"><tr><td><input type="date" class="notebook-input"></td><td><input type="text" class="notebook-input"></td><td><button class="btn-delete-row" onclick="deleteRow(this)">🗑️</button></td></tr></tbody></table>
            <div class="table-actions"><button class="btn-add-row" onclick="addRow('training-tbody')">➕ إضافة</button></div>
        </div>
        <div id="inspection-visits" class="content-section">
            <h3 class="section-title">زيارات تفتيشية</h3>
            <table><thead><tr><th>التاريخ</th><th>الزائر</th><th>ملاحظات</th><th class="actions-cell"></th></tr></thead><tbody id="inspection-tbody"><tr><td><input type="date" class="notebook-input"></td><td><input type="text" class="notebook-input"></td><td><textarea class="notebook-textarea"></textarea></td><td><button class="btn-delete-row" onclick="deleteRow(this)">🗑️</button></td></tr></tbody></table>
            <div class="table-actions"><button class="btn-add-row" onclick="addRow('inspection-tbody')">➕ إضافة</button></div>
        </div>
        <div id="teachers-list" class="content-section">
            <h3 class="section-title">قائمة الأساتذة</h3>
            <table><thead><tr><th>المادة</th><th>الأستاذ</th><th class="actions-cell"></th></tr></thead><tbody id="teachers-tbody"><tr><td><input type="text" class="notebook-input"></td><td><input type="text" class="notebook-input"></td><td><button class="btn-delete-row" onclick="deleteRow(this)">🗑️</button></td></tr></tbody></table>
            <div class="table-actions"><button class="btn-add-row" onclick="addRow('teachers-tbody')">➕ إضافة</button></div>
        </div>
        <div id="teacher-notepad" class="content-section">
            <h3 class="section-title">مفكرة الأستاذ</h3>
            <textarea style="width: 100%; height: 500px; border: 1px solid #ccc; padding: 15px;"></textarea>
        </div>
    </div>
</div>

<!-- Modals and Print Containers -->
<div id="qr-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeQrModal()">×</span><h4>رمز QR</h4><div id="qrcode-container"></div><div id="modal-student-info"></div></div></div>
<div id="print-qr-container"></div>

<script>
    // === SCRIPT FOR NOTEBOOK NAVIGATION ===
    function showSection(sectionId) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.getElementById(sectionId)?.classList.add('active');
        document.querySelectorAll('.sidebar ul li').forEach(li => {
            li.classList.toggle('active', li.getAttribute('onclick') === `showSection('${sectionId}')`);
        });
        if (sectionId !== 'attendance-system' && window.stopQrScanner) {
            window.stopQrScanner();
        }
    }

    // === DYNAMIC TABLE SCRIPT ===
    function addRow(tbodyId) {
        const tbody = document.getElementById(tbodyId);
        if (!tbody) return;
        const templateRow = tbody.querySelector('tr');
        if (!templateRow) return; 
        const newRow = templateRow.cloneNode(true);
        newRow.querySelectorAll('input, textarea').forEach(input => {
            input.value = (input.type === 'number') ? '' : '';
        });
        tbody.appendChild(newRow);
        if (tbodyId === 'grading-tbody') {
            renumberGradingTable(tbodyId);
        }
    }

    function deleteRow(button, tbodyId = null) {
        const row = button.closest('tr');
        if (row.parentElement.rows.length > 1) {
            row.remove();
        } else {
            row.querySelectorAll('input, textarea').forEach(input => {
                input.value = (input.type === 'number') ? '' : '';
            });
        }
        if (tbodyId === 'grading-tbody') {
            renumberGradingTable(tbodyId);
        }
    }

    function renumberGradingTable(tbodyId) {
        const tbody = document.getElementById(tbodyId);
        tbody.querySelectorAll('tr').forEach((row, index) => {
            const firstCell = row.querySelector('td');
            if (firstCell) firstCell.textContent = String(index + 1).padStart(2, '0');
        });
    }

    function addSeat(containerId) {
        const grid = document.getElementById(containerId);
        const newSeat = document.createElement('div');
        newSeat.className = 'seat';
        newSeat.innerHTML = `<input type="text" class="notebook-input"><button class="btn-delete-seat" onclick="deleteSeat(this)">×</button>`;
        grid.appendChild(newSeat);
    }
    
    function deleteSeat(button) {
        const seat = button.closest('.seat');
        if (seat.parentElement.children.length > 1) {
            seat.remove();
        } else {
            seat.querySelector('input').value = '';
        }
    }

    // === INITIALIZE PAGE AND ATTENDANCE SYSTEM ===
    document.addEventListener('DOMContentLoaded', () => {
        showSection('welcome-page');
        
        // --- Attendance System ---
        function initializeAttendanceSystem() {
            const managementView = document.getElementById('management-view');
            const reportView = document.getElementById('report-view');
            const addStudentForm = document.getElementById('add-student-form');
            const firstNameInput = document.getElementById('first-name');
            const lastNameInput = document.getElementById('last-name');
            const studentIdInput = document.getElementById('student-id');
            const classNameInput = document.getElementById('class-name');
            const addStudentStatus = document.getElementById('add-student-status');
            const importFileInput = document.getElementById('import-file');
            const importStudentsBtn = document.getElementById('import-students-btn');
            const importStatus = document.getElementById('import-status');
            const studentListBody = document.getElementById('student-list-body');
            const totalStudentsCountEl = document.getElementById('total-students-count');
            const exportStudentsCsvBtn = document.getElementById('export-students-csv-btn');
            const startScanBtn = document.getElementById('start-scan-btn');
            const stopScanBtn = document.getElementById('stop-scan-btn');
            const qrReaderElement = document.getElementById('qr-reader');
            const qrScanStatus = document.getElementById('qr-scan-status');
            const goToReportBtn = document.getElementById('go-to-report-btn');
            const reportDateInput = document.getElementById('report-date');
            const refreshReportBtn = document.getElementById('refresh-report-btn');
            const backToManagementBtn = document.getElementById('back-to-management-btn');
            const attendancePercentageEl = document.getElementById('attendance-percentage');
            const presentCountEl = document.getElementById('present-count');
            const absentCountEl = document.getElementById('absent-count');
            const presentListBody = document.getElementById('present-list-body');
            const absentListBody = document.getElementById('absent-list-body');
            const exportReportCsvBtn = document.getElementById('export-report-csv-btn');
            const qrModal = document.getElementById('qr-modal');
            const qrcodeContainer = document.getElementById('qrcode-container');
            const modalStudentInfo = document.getElementById('modal-student-info');
            const printQrCardsBtn = document.getElementById('print-qr-cards-btn');
            const printQrContainer = document.getElementById('print-qr-container');
            let students = JSON.parse(localStorage.getItem('students')) || [];
            let html5QrCodeScanner = null;
            let liveAttendance = {};
            const saveStudents = () => localStorage.setItem('students', JSON.stringify(students));
            const getCurrentDateString = () => new Date().toISOString().split('T')[0];
            const getCurrentTimeString = () => new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });

            function showStatusMessage(element, message, type = 'info', duration = 5000) {
                element.textContent = message;
                element.className = `status-message ${type}`;
                if (duration > 0) {
                    setTimeout(() => { if (element.textContent === message) { element.textContent = ''; element.className = 'status-message'; }}, duration);
                }
            }
            
            function renderStudentList() {
                studentListBody.innerHTML = '';
                totalStudentsCountEl.textContent = students.length;
                const hasStudents = students.length > 0;
                exportStudentsCsvBtn.disabled = !hasStudents;
                printQrCardsBtn.disabled = !hasStudents;
                if (!hasStudents) {
                    studentListBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">لم يتم إضافة أي طلاب.</td></tr>';
                    return;
                }
                students.sort((a, b) => (a.firstName + " " + a.lastName).localeCompare(b.firstName + " " + b.lastName));
                students.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${student.id}</td><td>${student.firstName}</td><td>${student.lastName}</td><td>${student.className}</td><td><button class="btn btn-action btn-small show-qr-btn" data-index="${index}"><i class="fas fa-qrcode"></i></button> <button class="btn btn-delete btn-small" data-index="${index}"><i class="fas fa-trash-alt"></i></button></td>`;
                    studentListBody.appendChild(row);
                });
            }

            function showQrCode(index) {
                const student = students[index];
                if (!student) return;
                modalStudentInfo.textContent = `الطالب: ${student.firstName} ${student.lastName}`;
                qrcodeContainer.innerHTML = '';
                try { new QRCode(qrcodeContainer, { text: student.id, width: 256, height: 256 }); qrModal.style.display = "block"; } catch (e) { console.error(e); }
            }
            window.closeQrModal = () => qrModal.style.display = "none";
            window.onclick = (event) => { if (event.target == qrModal) closeQrModal(); };

            addStudentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = studentIdInput.value.trim();
                if (students.some(s => s.id === id)) { showStatusMessage(addStudentStatus, `رقم التعريف ${id} مستخدم.`, 'error'); return; }
                students.push({ id, firstName: firstNameInput.value.trim(), lastName: lastNameInput.value.trim(), className: classNameInput.value.trim() });
                saveStudents(); renderStudentList(); showStatusMessage(addStudentStatus, 'تمت الإضافة بنجاح.', 'success'); addStudentForm.reset();
            });

            studentListBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const index = btn.dataset.index;
                if (btn.classList.contains('show-qr-btn')) showQrCode(index);
                if (btn.classList.contains('btn-delete')) {
                    if (confirm(`تأكيد حذف الطالب ${students[index].firstName}?`)) {
                        students.splice(index, 1);
                        saveStudents(); renderStudentList();
                    }
                }
            });
            
            importStudentsBtn.addEventListener('click', () => {
                const file = importFileInput.files[0];
                if (!file) { showStatusMessage(importStatus, "اختر ملف أولاً.", 'error'); return; }
                const reader = new FileReader();
                reader.onload = (event) => {
                    let parsedData;
                    if (file.name.endsWith('.csv')) { parsedData = Papa.parse(event.target.result, { header: true, skipEmptyLines: true }).data; } 
                    else { const workbook = XLSX.read(event.target.result, { type: 'array' }); parsedData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); }
                    processImportedData(parsedData);
                };
                if (file.name.endsWith('.csv')) reader.readAsText(file); else reader.readAsArrayBuffer(file);
            });

            function processImportedData(data) {
                let importedCount = 0, skippedCount = 0;
                data.forEach(row => {
                    const keys = Object.keys(row);
                    const id = String(row[keys[0]] || '').trim();
                    const firstName = String(row[keys[1]] || '').trim();
                    const lastName = String(row[keys[2]] || '').trim();
                    const className = String(row[keys[3]] || '').trim();
                    if(id && firstName && !students.some(s => s.id === id)) { students.push({ id, firstName, lastName, className }); importedCount++; } else { skippedCount++; }
                });
                saveStudents(); renderStudentList(); showStatusMessage(importStatus, `تم استيراد ${importedCount} طالب وتخطي ${skippedCount}.`, 'success');
            }

            function onScanSuccess(decodedText) {
                const student = students.find(s => s.id === decodedText.trim());
                if (student) {
                    const time = getCurrentTimeString();
                    if (!liveAttendance[student.id]) { liveAttendance[student.id] = time; showStatusMessage(qrScanStatus, `تم تسجيل: ${student.firstName} في ${time}`, 'success'); if(reportView.classList.contains('active-view')) generateAndDisplayReport(); } 
                    else { showStatusMessage(qrScanStatus, `${student.firstName} مسجل بالفعل.`, 'info'); }
                } else { showStatusMessage(qrScanStatus, `رقم التعريف ${decodedText} غير موجود.`, 'error'); }
            }

            function startQrScanner() {
                startScanBtn.style.display = 'none'; stopScanBtn.style.display = 'inline-flex'; qrReaderElement.style.display = 'block'; showStatusMessage(qrScanStatus, 'جاري تفعيل الكاميرا...', 'info', 0);
                try { html5QrCodeScanner = new Html5Qrcode("qr-reader"); html5QrCodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess, (e)=>{}); } catch(e) { console.error(e); }
            }
            window.stopQrScanner = function() { if (html5QrCodeScanner && html5QrCodeScanner.isScanning) { html5QrCodeScanner.stop(); startScanBtn.style.display = 'inline-flex'; stopScanBtn.style.display = 'none'; qrReaderElement.style.display = 'none'; showStatusMessage(qrScanStatus, 'تم إيقاف الماسح.', 'info'); }};
            startScanBtn.addEventListener('click', startQrScanner);
            stopScanBtn.addEventListener('click', window.stopQrScanner);

            function generateAndDisplayReport() {
                if (!reportDateInput.value) return; let presentCount = 0, absentCount = 0; presentListBody.innerHTML = ''; absentListBody.innerHTML = '';
                students.forEach(student => {
                    const time = liveAttendance[student.id];
                    if (time) { presentListBody.innerHTML += `<tr><td>${student.firstName} ${student.lastName}</td><td>${student.className}</td><td>${time}</td></tr>`; presentCount++; } 
                    else { absentListBody.innerHTML += `<tr><td>${student.firstName} ${student.lastName}</td><td>${student.className}</td></tr>`; absentCount++; }
                });
                const total = students.length;
                attendancePercentageEl.textContent = total > 0 ? `${((presentCount / total) * 100).toFixed(1)}%` : '0%';
                presentCountEl.textContent = presentCount; absentCountEl.textContent = absentCount; exportReportCsvBtn.disabled = total === 0;
            }

            const switchView = (viewToShow) => { document.querySelectorAll('#attendance-system .view').forEach(v => v.classList.remove('active-view')); viewToShow.classList.add('active-view'); };
            goToReportBtn.addEventListener('click', () => { reportDateInput.value = getCurrentDateString(); generateAndDisplayReport(); switchView(reportView); });
            backToManagementBtn.addEventListener('click', () => switchView(managementView));
            refreshReportBtn.addEventListener('click', generateAndDisplayReport);
            
            function exportToCsv(filename, rows) {
                const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + rows.map(r => r.join(",")).join("\n");
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", filename);
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            }
            exportStudentsCsvBtn.addEventListener('click', () => { exportToCsv(`students.csv`, [["ID", "FirstName", "LastName", "Class"], ...students.map(s => [s.id, s.firstName, s.lastName, s.className])]); });
            exportReportCsvBtn.addEventListener('click', () => { const rows = [["ID", "Name", "Class", "Status", "Time"]]; students.forEach(s => { const time = liveAttendance[s.id]; rows.push([s.id, `${s.firstName} ${s.lastName}`, s.className, time ? 'Present' : 'Absent', time || '']); }); exportToCsv(`attendance_${reportDateInput.value}.csv`, rows); });

            printQrCardsBtn.addEventListener('click', () => {
                printQrContainer.innerHTML = ''; let currentPage = document.createElement('div'); currentPage.className = 'print-page'; printQrContainer.appendChild(currentPage);
                students.forEach((student, index) => {
                    if (index > 0 && index % 10 === 0) { currentPage = document.createElement('div'); currentPage.className = 'print-page'; printQrContainer.appendChild(currentPage); }
                    const card = document.createElement('div'); card.className = 'qr-card'; const qrDiv = document.createElement('div'); const infoDiv = document.createElement('div');
                    infoDiv.innerHTML = `<p><strong>${student.firstName} ${student.lastName}</strong></p><p>ID: ${student.id}</p>`;
                    card.append(qrDiv, infoDiv); currentPage.appendChild(card); new QRCode(qrDiv, { text: student.id, width: 120, height: 120 });
                });
                setTimeout(() => window.print(), 500);
            });
            renderStudentList();
        }
        initializeAttendanceSystem();
    });
</script>

</body>
</html>